<!DOCTYPE html>
<html data-ng-app="lukeburroughs">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0"> 
    	<title>AngularJS Demo</title>
    	<link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico" />
		<link rel="stylesheet" type="text/css" href="js/lib/background-slideshow/css/component.css" />
		<link rel="stylesheet" type="text/css" href="css/app.css" />
	</head>
	<body data-ng-controller="mainController" data-ng-style="colours">

		<div id="main">

			<header data-ng-include="'templates/navigation.html'"></header>
			<div data-ng-include="'templates/secondary.html'"></div>
			<div data-ng-view></div>

			<overlay data-ng-if="overlay.name" name="overlay.name">
				<div data-ng-include="overlay.src"></div>
			</overlay>

		</div>

		<!-- Scripts -->
		<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
		<script src="js/lib/modernizr.custom.js"></script>
		<script src="js/lib/background-slideshow/js/jquery.imagesloaded.min.js"></script>
		<script src="js/lib/background-slideshow/js/cbpBGSlideshow.js"></script>

		<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.2.16/angular.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.2.16/angular-route.js"></script>
		<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.2.16/angular-resource.js"></script>
		<script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
		<script src="config.js"></script>

		<script>

		var app = angular.module('lukeburroughs', ['ngRoute', 'ngResource', 'config']);

		/**
		 * Routing
		 */
		app.config(function( $routeProvider ) {
			$routeProvider
				.when('/', {
					templateUrl: 'templates/index.html'
				})
				.when('/project/:name', {
					controller: 'projectController',
					templateUrl: 'templates/project.html'
				})
				.otherwise({
					redirectTo: '/'
				});
		});

		/**
		 * Pads a number with preceeding zeroes e.g. 5 becomes 005
		 */
		app.filter('padNumber', function() {
			return function pad( input, length ) {
				input = input.toString();
				return input.length < length ? pad("0" + input, length) : input;
		    };
		});

		app.factory('Project', function( $http ) {
			var factory = {
					projects: []
				};

			$http.get('projects.json')
				.success(function( data ) {
					angular.forEach(data, function( project ) {
						// Point slide src to project's asset directory
						angular.forEach(project.slides, function( slide ) {
							slide.src = 'projects/' + project.id + '/' + slide.image;
						});

						// Add project to binded project list
						factory.projects.push( project );
					});
				});

			factory.get = function( projectId )  {
				return _.findWhere(factory.projects, { id: projectId });
			}

			return factory;
		});

		app.directive('slideshow', function( $timeout ) {
			return {
				restrict: 'E',
				templateUrl: 'templates/directives/slideshow.html',
				scope: {
					slides: '=',
					onchange: '&'
				},
				link: function( scope, element, attrs ) {
					$timeout(function() {
						cbpBGSlideshow.init();
					});

					element.on('slide-init slide-change', function( evt, slide ) {
						scope.onchange({ slide: slide });
					});
				}
			}
		});

		app.controller('projectController', function( $scope, $location, $routeParams, Project ) {
			if( $routeParams.name ) {
				$scope.project = Project.get( $routeParams.name );
			}

			/**
			 * Slide change and initialisation callback
			 */
			$scope.changeSlide = function( slide ) {
				if( slide && $scope.project ) {
					var slideIndex = $(slide).index(),
						slide = $scope.project.slides[ slideIndex ];

					// Updates the text and background colour according to the current slide config
					$scope.$emit('slide-change', slide);
				}
			}
		});

		app.directive('overlay', function() {
			return {
				restrict: 'E',
				replace: true,
				transclude: true,
				templateUrl: 'templates/directives/overlay.html',
				scope: {
					name: '=',
					show: '&'
				},
				link: function( scope, element, attrs ) {
					scope.show = function() {
						debugger;
					}
				},
				controller: function( $scope ) {
					// TODO: Avoid using $parent
					$scope.show = $scope.$parent.show;
				}
			}
		});

		// TODO: Pass in hide/show text values
		app.directive('toggle', function() {
			return {
				restrict: 'E',
				transclude: true,
				scope: {
					open: '=isOpen'
				},
				templateUrl: 'templates/directives/toggle.html',
				link: function( scope, element, attrs ) {
					scope.isOpen = angular.isDefined(attrs.open) ? scope.$eval(attrs.open) : false;
					scope.text = (scope.isOpen) ? 'Hide Info' : 'Show Info';

					element.on('click', function() {
						scope.$apply(function() {
							scope.isOpen = !scope.isOpen;
						});
					});
				}
			}
		});

		app.controller('mainController', function( $scope, Project, HOMEPAGE ) {
			$scope.projects = Project.projects;
			$scope.slides = HOMEPAGE.slides;

			$scope.show = function( overlayName ) {
				$scope.overlay = {
					name: overlayName,
					src: 'templates/overlays/' + overlayName + '.html'
				};
			}

			/**
			 * Updates text and background colours on slide update
			 */
			$scope.$on('slide-change', function( evt, slide ) {
				$scope.$apply(function() {
					$scope.colours = {
						'color': slide.colour,
						'background-color': slide.background
					};
				});
			});
		});

		app.controller('navController', function( $scope, $rootScope, $routeParams, Project ) {
			// Listen for route changes as the controller is outside of ng-view
			$rootScope.$on('$routeChangeSuccess', function( evt, current, previous ) {
				$scope.project = null;

				if( $routeParams.name ) {
					// Set the current project based on route argument
					$scope.project = Project.get( $routeParams.name );

					// Expand projects list for project pages
					// By default it will be close on non-project pages but maintain it's open state between routes
					if( !!$scope.project ) {
						$scope.showProjectList = true;
					}

					// Don't show all projects by default for project pages, otherwise show
					$scope.listAllProjects = !$scope.project;
				}
			});
		});

		</script>
	</body>
</html>